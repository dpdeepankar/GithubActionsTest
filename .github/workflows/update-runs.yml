name: Update Workflow Runs Data

on:
  schedule:
    - cron: '0 */4 * * *'   # every 4 hours
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Fetch and process workflow runs
        env:
         GH_TOKEN: ${{ secrets.GITHUB_PAT }}
        run: |
         RESPONSE=$(curl -s -H "Authorization: token $GH_TOKEN" \
                    -H "Accept: application/vnd.github.v3+json" \
                    "https://api.github.com/repos/dpdeepankar/AdoToGithubAction/actions/runs?per_page=50")

         # Write jq filter to a temporary file (safest way to avoid quoting hell)
         cat > filter.jq << 'EOF'
          .workflow_runs // [] | map({
          name: .name,
          branch: .head_branch // "â€”",
          status: .status,
          conclusion: .conclusion // "Pending",
          created_at: .created_at,
          html_url: .html_url
          })
         EOF

         # Check if response is valid JSON with workflow_runs
         if echo "$RESPONSE" | jq -e '.workflow_runs' >/dev/null 2>&1; then
          echo "$RESPONSE" | jq -f filter.jq > data.json
         else
          echo "[]" > data.json
         echo "Warning: Invalid API response or no runs found" >&2
         fi

         # Clean up
         rm -f filter.jq
         

      - name: Commit changes if any
        uses: EndBug/add-and-commit@v9
        with:
          add: 'release-dashboard/data.json'
          message: 'Update workflow runs data [skip ci]'
          default_author: github_actions
